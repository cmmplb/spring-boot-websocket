<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cmmplb.websocket.dao.MessageRecordMapper">
    <sql id="base_column">
        <!--@sql select-->
        cmr.`id`
             , cmr.`type`
             , cmr.`send_business_id`
             , cmr.`receive_business_id`
             , cmr.`message`
             , cmr.`create_time`
             , cmr.`create_by`
             , cmr.`update_time`
             , cmr.`update_by`
        <!--@sql from `chat_message_record` cmr-->
    </sql>

    <sql id="base_select">
        select
        <include refid="base_column"/>
        from `chat_message_record` cmr
    </sql>

    <select id="selectByPaged" resultType="com.cmmplb.websocket.vo.MessageRecordVO">
        <!-- 作为接收人 -->
        select
          cmr.`id` as id
        , cmr.`send_business_id` as businessId
        , cmr.`type`             as type
        , cmr.`message`          as message
        , cmr.`send_time`        as sendTime
        ,if(cmr.`type` = 1, su.`name`, ccg.`name`) as name
        ,if(cmr.`type` = 1, sau.`url`, sac.`url`)  as avatar
        from `chat_message_record` cmr
        left join `sys_user` su on su.`id` = cmr.`send_business_id` and cmr.`type` = 1
        left join `sys_attachment` sau on sau.`id` = su.`avatar`
        left join `chat_contact_group` ccg on ccg.id = cmr.`send_business_id` and cmr.`type` = 2
        left join `sys_attachment` sac on sac.`id` = ccg.`avatar`
        <where>
            <!-- 类型:1-用户;2-群 -->
            <if test="dto.type == 1">
                and cmr.`receive_business_id` = #{userId}
            </if>
            <if test="dto.type == 2">
                and cmr.`receive_business_id` = #{dto.businessId}
            </if>
        </where>
        order by cmr.`create_time` desc
    </select>

    <select id="selectUserMessageRecordByPaged" resultType="com.cmmplb.websocket.vo.MessageRecordVO">
        select * from (
        <!-- 作为接收人 -->
        select cmr.`id`               as id
              , cmr.`send_business_id` as businessId
              , if(cmr.`send_business_id` = #{userId}, 1, 2) send
              , cmr.`type`             as type
              , cmr.`message`          as message
              , cmr.`send_time`        as sendTime
              , su.`name`              as name
              , sau.`url`              as avatar
         from `chat_message_record` cmr
                  left join `sys_user` su on su.`id` = cmr.`send_business_id` and cmr.`type` = 1
                  left join `sys_attachment` sau on sau.`id` = su.`avatar`
         where cmr.`receive_business_id` = #{userId}
           and cmr.`send_business_id` = #{businessId}
        union all
        <!-- 作为发送人 -->
        select cmr.`id`                  as id
              , cmr.`receive_business_id` as businessId
              , if(cmr.`send_business_id` = #{userId}, 1, 2) send
              , cmr.`type`                as type
              , cmr.`message`             as message
              , cmr.`send_time`           as sendTime
              , su.`name`                 as name
              , sau.`url`                 as avatar
         from `chat_message_record` cmr
                  left join `sys_user` su on su.`id` = cmr.`send_business_id` and cmr.`type` = 1
                  left join `sys_attachment` sau on sau.`id` = su.`avatar`
         where cmr.`receive_business_id` = #{businessId}
           and cmr.`send_business_id` = #{userId}) cmr
        order by cmr.`sendTime` desc
    </select>

    <select id="selectGroupMessageRecordByPaged" resultType="com.cmmplb.websocket.vo.MessageRecordVO">
        select cmr.`id`               as id
             , cmr.`send_business_id` as businessId
             , cmr.`type`             as type
             , cmr.`message`          as message
             , cmr.`send_time`        as sendTime
             , ccg.`name`             as name
             , sau.`url`              as avatar
        from `chat_message_record` cmr
                 left join `chat_contact_group` ccg on ccg.`id` = cmr.`send_business_id` and cmr.`type` = 2
                 left join `chat_contact_group_user` ccgu on ccgu.`contact_group_id` = ccg.`id`
                 left join `sys_attachment` sau on sau.`id` = ccg.`avatar`
        where cmr.`send_business_id` = #{businessId}
          and ccgu.`user_id` = #{userId}
        order by cmr.`send_time` desc
    </select>
</mapper>